pipeline {
  agent { label 'agent' }
  environment {
    LW_ACCESS_TOKEN = credentials('lw-access-token')
    LW_ACCOUNT_NAME = credentials('lw-account-name')
    IMAGE_TAG = env.BUILD_ID
  }
  stages {
    stage('checkout') {
      steps {
        checkout scm
      }
    }
    stage('Build') {
      steps {
        sh 'scripts/build_frontend.sh'
      }
    }
    stage('Create Image') {
      steps {
        script {
          docker.build("detcaccounts/ticketing-bff:${env.BUILD_ID}", "-f docker/Dockerfile_frontend ./artifacts")
        }
      }
    }
    stage('Scan') {
        steps {
            sh "curl -L https://github.com/lacework/lacework-vulnerability-scanner/releases/latest/download/lw-scanner-linux-amd64 -o lw-scanner"
            sh "chmod +x lw-scanner"
            sh "./lw-scanner image evaluate detcaccounts/ticketing-bff ${env.BUILD_ID} --build-id ${env.BUILD_ID} --build-plan ${JOB_NAME} --policy -c --fail-on-violation-exit-code 1 --critical-violation-exit-code 2 --high-violation-exit-code 3 --medium-violation-exit-code 4 --low-violation-exit-code 5 --info-violation-exit-code 6"
        }
    }
    stage('Deploy') {
      steps {
        sh 'detc create --plan https://raw.githubusercontent.com/lacework-demo/ticketing-app/ipcrm/jenkinsfile_frontend/deploy/ticketing-gcp.yaml --apply --trace --step frontend-k8s'
      }
    }
  }
}
